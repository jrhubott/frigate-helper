# Frigate-Helper

## Overview
Frigate-Helper is a .NET 8.0-based service designed to interact with MQTT brokers, particularly for subscribing and publishing messages related to object events. The primary use case is to enhance integration with home automation systems like Home Assistant, assisting with the handling of MQTT messages for Frigate, a real-time object detection system using a camera.

This service can subscribe to specific MQTT topics, process incoming events, and publish corresponding statistics or events back to the broker.

## Features

- **MQTT Integration**: Connects to an MQTT broker to subscribe to topics and publish data.
- **Event Handling**: Processes incoming Frigate object events.
- **Statistics System**: Tracks and updates statistics about detected events, publishing them to relevant MQTT topics.
- **Periodic Updates**: Performs periodic refreshes of stored statistics.
- **Integration with Home Assistant**: Uses MQTT to interact with Home Assistant for event publication.

## Prerequisites

- **MQTT Broker**: A configured MQTT broker with the relevant topics.
- **.NET 8.0 SDK**: This project requires [.NET 8](https://dotnet.microsoft.com/en-us/download/dotnet/8.0).

## Getting Started

### 1. Clone the project
```bash
git clone <repo-url>
cd Frigate-Helper
```

### 2. Configure the environment

Inside the `docker-compose.yml` or environment variables file, adjust the following:

- `SERVER`: MQTT broker server address (for example: `home-assistant.home:1883`)
- `SUBSCRIBE_TOPIC`: MQTT topic to subscribe to (default: `frigate/events`)
- `PUBLISH_TOPIC`: MQTT topic to publish object events (default: `frigate_objects`)
- `CLIENTID`: MQTT client identifier
- `USERNAME`: MQTT broker username
- `PASSWORD`: MQTT broker password

You can also customize log levels in `appsettings.json` for error reporting and diagnostics.

### 3. Build and Run the Service
You can build and run the service using Docker or manually with the .NET SDK.

#### a. Run with Docker Compose
Ensure you have Docker installed, then use:

```bash
docker-compose up --build
```

#### b. Run Manually
If you'd prefer to run the application manually:

```bash
dotnet build
dotnet run
```

Make sure you have the necessary environment variables set up before running the service.

## Architecture

### Components:

1. **MqttClient.cs**: Handles connecting to the MQTT broker, subscribing to topics, and publishing messages.
2. **Worker.cs**: A background service that runs, periodically refreshing statistics and handling incoming events.
3. **StatisticHelper.cs**: Responsible for managing statistics, including storing and refreshing them.
4. **EventHandler.cs**: Handles Frigate event logic, such as adding, updating, and clearing detected object events.
5. **Event.cs**: Model class to represent a Frigate event, including its metadata and lifecycle information.

### Main Flow:
- **Subscription**: The MQTT client subscribes to the specified Frigate events topic.
- **Event Handling**: On new messages, the event handler processes incoming data and updates corresponding statistics.
- **Publishing**: After processing, the service publishes updated information (like statistics) to predefined topics on the MQTT broker.

## Environment Variables

| Variable         | Description                             | Default Value         |
| ---------------- | --------------------------------------- | --------------------- |
| `SERVER`         | Hostname or IP of the MQTT broker       | `home-assistant.home:1883` |
| `SUBSCRIBE_TOPIC`| MQTT topic for subscribing to events    | `frigate/events`      |
| `PUBLISH_TOPIC`  | MQTT topic for publishing object info   | `frigate_objects`     |
| `CLIENTID`       | MQTT Client ID                          | `frigate_hass_object_events` |
| `USERNAME`       | MQTT Username (if required)             | `mqtt`                |
| `PASSWORD`       | MQTT Password (if required)             | `mqtt`                |

## MQTT Events Generated

The following MQTT events are generated by this system, particularly by the publishing of statistics and updates:

### 1. **Subscribed Events (Input Events)**
The application subscribes to the following MQTT topics:
- **`frigate/events`**: This topic listens for JSON-formatted events from Frigate. These events contain information about object detections, updates, or end of events. The events are further processed and results are generated.

### 2. **Published Events (Output Events)**

#### a. **Statistics on Object Events**
Each Frigate object event generates corresponding statistics (such as "moving" or "stationary" counts). These statistics are published periodically or when events are processed.

- **`frigate_helper/<base_topic>/moving`**:  
  A message published when an object is detected moving, containing the count of moving objects.

- **`frigate_helper/<base_topic>/stationary`**:  
  A message published when an object is recorded stationary, containing the count of stationary objects.

- **General stats on objects**:  
  A combination of multiple statistics is published based on the event and calculations done by the `StatisticHelper`.

#### Example payload:
```json
{
  "topic": "frigate_helper/mycamera/moving",
  "payload": "3"
}
```
This indicates 3 objects were detected moving on the camera named `mycamera`.

- **Event End Statistics**:
  When an event ends, it triggers a final update with corresponding statistics, such as how many objects were seen, their state, and other relevant data.

### Publishing Syntax

Each statistic or event is published in the `frigate_helper/<camera_name or custom>/<event property>` format.

For example:
- **Topic**: `frigate_helper/camera1/stats/moving`
- **Payload**: `5` (This would represent 5 movable objects captured by "camera1".)

General statistics for an event are constructed in the following topic format:
- `frigate_helper/<base_topic>/<event_type>/<statistic>`

### 3. **Periodic Refresh Events**

- Every 60 seconds, the service triggers a periodic refresh, generating MQTT messages for all stored statistics, publishing any updated values.
- The refresh events occur in the topics configured dynamically based on event names and identifiers.

## Customizing Behavior

You can modify:

- **MQTT Topics**: Change what topics the service subscribes or publishes to by altering the environment variables or `docker-compose.yml`.
- **Statistics**: Modify the statistics structure and logic via `StatisticHelper.cs` and `Statistic.cs` for various kinds of monitoring or event processing.

## Logging

The service uses the .NET logging system. You can configure logging verbosity in the `appsettings.json` file.

## Contributing

Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.

## License

This project is licensed under the MIT License.